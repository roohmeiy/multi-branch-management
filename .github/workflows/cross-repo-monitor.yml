name: Cross-Repo Monitor

on:
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    env:
      REPO_A_URL: https://github.com/roohmeiy/my_ui_repo.git
      REPO_A_OWNER: roohmeiy
      REPO_A_REPO: my_ui_repo

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TOKEN }}
          fetch-depth: 0

      - name: Check for changes and deploy
        run: |
          # Get current commits
          EN_COMMIT=$(git ls-remote $REPO_A_URL refs/heads/en | awk '{print $1}')
          FR_COMMIT=$(git ls-remote $REPO_A_URL refs/heads/fr | awk '{print $1}')
          
          # Load previous commits
          mkdir -p .cache
          if [ -f .cache/last-commits.json ]; then
            PREV_EN=$(jq -r '.en' .cache/last-commits.json)
            PREV_FR=$(jq -r '.fr' .cache/last-commits.json)
          else
            PREV_EN=""
            PREV_FR=""
          fi
          
          echo "Current: EN=$EN_COMMIT, FR=$FR_COMMIT"
          echo "Previous: EN=$PREV_EN, FR=$PREV_FR"
          
          # Deploy EN if changed
          if [ "$EN_COMMIT" != "$PREV_EN" ] && [ -n "$PREV_EN" ]; then
            echo "ðŸš€ Triggering EN deployment..."
            curl -X POST \
              -H "Authorization: token ${{ secrets.TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO_A_OWNER/$REPO_A_REPO/dispatches \
              -d '{"event_type":"deploy-EN","client_payload":{"sha":"'$EN_COMMIT'"}}'
          fi
          
          # Deploy FR if changed  
          if [ "$FR_COMMIT" != "$PREV_FR" ] && [ -n "$PREV_FR" ]; then
            echo "ðŸš€ Triggering FR deployment..."
            curl -X POST \
              -H "Authorization: token ${{ secrets.TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO_A_OWNER/$REPO_A_REPO/dispatches \
              -d '{"event_type":"deploy-FR","client_payload":{"sha":"'$FR_COMMIT'"}}'
          fi
          
          # Update cache
          echo "{\"en\":\"$EN_COMMIT\",\"fr\":\"$FR_COMMIT\"}" > .cache/last-commits.json
          
          # Commit changes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .cache/last-commits.json
          git commit -m "Update last commit SHAs [skip ci]" || echo "No changes to commit"
          git push
