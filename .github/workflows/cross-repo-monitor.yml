name: Cross-Repo Monitor

on:
  workflow_dispatch:

env:
  REPO_A: 'roohmeiy/my_ui_repo'

jobs:
  monitor-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.TOKEN }}
        
    - name: Check and deploy changes
      run: |
        # Get stored commit SHAs
        STORED_EN_SHA=$([ -f .last-repo-a-en-commit ] && cat .last-repo-a-en-commit || echo '')
        STORED_FR_SHA=$([ -f .last-repo-a-fr-commit ] && cat .last-repo-a-fr-commit || echo '')
        
        # Get current commit SHAs
        CURRENT_EN_SHA=$(curl -s -H "Authorization: token ${{ secrets.TOKEN }}" \
          "https://api.github.com/repos/${{ env.REPO_A }}/commits/EN" | jq -r '.sha')
        CURRENT_FR_SHA=$(curl -s -H "Authorization: token ${{ secrets.TOKEN }}" \
          "https://api.github.com/repos/${{ env.REPO_A }}/commits/FR" | jq -r '.sha')
        
        # Check and deploy EN branch
        if [ "$STORED_EN_SHA" != "$CURRENT_EN_SHA" ] && [ -n "$STORED_EN_SHA" ]; then
          echo "ðŸš€ Deploying EN branch..."
          curl -X POST -H "Authorization: token ${{ secrets.TOKEN }}" \
            "https://api.github.com/repos/${{ env.REPO_A }}/actions/workflows/EN-deployment.yml/dispatches" \
            -d '{"ref":"main","inputs":{"triggered_by":"cross-repo-monitor","source_branch":"EN","commit_sha":"'$CURRENT_EN_SHA'"}}'
        fi
        
        # Check and deploy FR branch
        if [ "$STORED_FR_SHA" != "$CURRENT_FR_SHA" ] && [ -n "$STORED_FR_SHA" ]; then
          echo "ðŸš€ Deploying FR branch..."
          curl -X POST -H "Authorization: token ${{ secrets.TOKEN }}" \
            "https://api.github.com/repos/${{ env.REPO_A }}/actions/workflows/FR-deployment.yml/dispatches" \
            -d '{"ref":"main","inputs":{"triggered_by":"cross-repo-monitor","source_branch":"FR","commit_sha":"'$CURRENT_FR_SHA'"}}'
        fi
        
        # Update stored commit SHAs
        echo "$CURRENT_EN_SHA" > .last-repo-a-en-commit
        echo "$CURRENT_FR_SHA" > .last-repo-a-fr-commit
        
        # Commit changes
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .last-* && git commit -m "Update commit tracking [skip ci]" && git push || true
        
