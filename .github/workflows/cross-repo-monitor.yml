name: Cross-Repo Monitor

on:
  workflow_dispatch:

env:
  REPO_A: 'roohmeiy/my_ui_repo'
  REPO_B: 'roohmeiy/multi-branch-management'

jobs:
  monitor-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.TOKEN }}
        
    - name: Get stored commit SHAs
      id: stored-commits
      run: |
        echo "repo_a_en_sha=$([ -f .last-repo-a-en-commit ] && cat .last-repo-a-en-commit || echo '')" >> $GITHUB_OUTPUT
        echo "repo_a_fr_sha=$([ -f .last-repo-a-fr-commit ] && cat .last-repo-a-fr-commit || echo '')" >> $GITHUB_OUTPUT
        
    - name: Get current commit SHAs
      id: current-commits
      run: |
        REPO_A_EN_SHA=$(curl -s -H "Authorization: token ${{ secrets.TOKEN }}" \
          "https://api.github.com/repos/${{ env.REPO_A }}/commits/EN" | jq -r '.sha')
        REPO_A_FR_SHA=$(curl -s -H "Authorization: token ${{ secrets.TOKEN }}" \
          "https://api.github.com/repos/${{ env.REPO_A }}/commits/FR" | jq -r '.sha')
        
        echo "repo_a_en_sha=$REPO_A_EN_SHA" >> $GITHUB_OUTPUT
        echo "repo_a_fr_sha=$REPO_A_FR_SHA" >> $GITHUB_OUTPUT
        
    - name: Check changes
      id: changes
      run: |
        # Check if Repo A EN branch changed
        EN_CHANGED=false
        if [ "${{ steps.stored-commits.outputs.repo_a_en_sha }}" != "${{ steps.current-commits.outputs.repo_a_en_sha }}" ] && [ -n "${{ steps.stored-commits.outputs.repo_a_en_sha }}" ]; then
          EN_CHANGED=true
        fi
        
        # Check if Repo A FR branch changed
        FR_CHANGED=false
        if [ "${{ steps.stored-commits.outputs.repo_a_fr_sha }}" != "${{ steps.current-commits.outputs.repo_a_fr_sha }}" ] && [ -n "${{ steps.stored-commits.outputs.repo_a_fr_sha }}" ]; then
          FR_CHANGED=true
        fi
        
        echo "en-deploy=$EN_CHANGED" >> $GITHUB_OUTPUT
        echo "fr-deploy=$FR_CHANGED" >> $GITHUB_OUTPUT
        
    - name: Deploy EN
      if: steps.changes.outputs.en-deploy == 'true'
      run: |
        curl -X POST -H "Authorization: token ${{ secrets.TOKEN }}" \
          "https://api.github.com/repos/${{ env.REPO_A }}/actions/workflows/EN-deployment.yml/dispatches" \
          -d '{"ref":"main","inputs":{"triggered_by":"cross-repo-monitor","source_branch":"EN"}}'
        
    - name: Deploy FR
      if: steps.changes.outputs.fr-deploy == 'true'
      run: |
        curl -X POST -H "Authorization: token ${{ secrets.TOKEN }}" \
          "https://api.github.com/repos/${{ env.REPO_A }}/actions/workflows/FR-deployment.yml/dispatches" \
          -d '{"ref":"main","inputs":{"triggered_by":"cross-repo-monitor","source_branch":"FR"}}'
        
    - name: Update stored commit SHAs
      if: always()
      run: |
        echo "${{ steps.current-commits.outputs.repo_a_en_sha }}" > .last-repo-a-en-commit
        echo "${{ steps.current-commits.outputs.repo_a_fr_sha }}" > .last-repo-a-fr-commit
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .last-* && git commit -m "Update commit tracking [skip ci]" && git push || true
