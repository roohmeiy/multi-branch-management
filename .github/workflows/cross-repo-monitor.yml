name: Cross-Repo Monitor

on:
  workflow_dispatch:

env:
  REPO_A: 'roohmeiy/my_ui_repo'
  REPO_B: 'roohmeiy/multi-branch-management'

jobs:
  monitor-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.TOKEN }}
        
    - name: Get last check
      id: last-check
      run: |
        echo "timestamp=$([ -f .last-check ] && cat .last-check || date -d '1 hour ago' -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
        
    - name: Check changes
      id: changes
      run: |
        LAST_CHECK="${{ steps.last-check.outputs.timestamp }}"
        
        # Check repo A main branch
        REPO_A_COMMITS=$(curl -s -H "Authorization: token ${{ secrets.TOKEN }}" \
          "https://api.github.com/repos/${{ env.REPO_A }}/commits?sha=main&since=$LAST_CHECK" | jq length)
        
        if [ "$REPO_A_COMMITS" -gt 0 ]; then
          # Check EN/FR branches in repo B
          EN_COMMITS=$(curl -s -H "Authorization: token ${{ secrets.TOKEN }}" \
            "https://api.github.com/repos/${{ env.REPO_B }}/commits?sha=EN&since=$LAST_CHECK" | jq length)
          FR_COMMITS=$(curl -s -H "Authorization: token ${{ secrets.TOKEN }}" \
            "https://api.github.com/repos/${{ env.REPO_B }}/commits?sha=FR&since=$LAST_CHECK" | jq length)
          
          echo "en-deploy=$([[ $EN_COMMITS -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "fr-deploy=$([[ $FR_COMMITS -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
        else
          echo "en-deploy=false" >> $GITHUB_OUTPUT
          echo "fr-deploy=false" >> $GITHUB_OUTPUT
        fi
    - name: Deploy EN
      if: steps.changes.outputs.en-deploy == 'true'
      run: |
        curl -X POST -H "Authorization: token ${{ secrets.TOKEN }}" \
          "https://api.github.com/repos/${{ env.REPO_A }}/actions/workflows/EN-deployment.yml/dispatches" \
          -d '{"ref":"main","inputs":{"triggered_by":"cross-repo-monitor","source_branch":"EN"}}'
        
    - name: Deploy FR
      if: steps.changes.outputs.fr-deploy == 'true'
      run: |
        curl -X POST -H "Authorization: token ${{ secrets.TOKEN }}" \
          "https://api.github.com/repos/${{ env.REPO_A }}/actions/workflows/fr-deployment.yml/dispatches" \
          -d '{"ref":"main","inputs":{"triggered_by":"cross-repo-monitor","source_branch":"FR"}}'
        
    - name: Update timestamp
      if: always()
      run: |
        date -u +%Y-%m-%dT%H:%M:%SZ > .last-check
        git add .last-check && git commit -m "Update timestamp [skip ci]" && git push || true
